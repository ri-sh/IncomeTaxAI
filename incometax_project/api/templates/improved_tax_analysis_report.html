<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Analysis Report - Old vs New Regime Comparison</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-muted: #64748b;
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary), #3b82f6);
            color: white;
            border-radius: 15px;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
        }

        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Regime Comparison - Main Focus */
        .regime-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .regime-card {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 25px;
            position: relative;
            transition: all 0.3s ease;
        }

        .regime-card.recommended {
            border-color: var(--success);
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.15);
        }

        .regime-card.not-recommended {
            border-color: var(--warning);
            opacity: 0.8;
        }

        .regime-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .regime-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        .recommended-badge {
            background: var(--success);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .not-recommended-badge {
            background: var(--warning);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .final-amount {
            font-size: 2rem;
            font-weight: bold;
            margin: 15px 0;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
        }

        .refund {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success);
        }

        .tax-payable {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }

        /* Input Sections */
        .input-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 25px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin: 0 0 20px 0;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .subtotal {
            background: rgba(37, 99, 235, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            text-align: right;
        }

        /* Calculation Details */
        .calculation-details {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .calc-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .calc-table th,
        .calc-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .calc-table th {
            background: rgba(37, 99, 235, 0.05);
            font-weight: 600;
        }

        .calc-table td.amount {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .total-row {
            font-weight: bold;
            background: rgba(37, 99, 235, 0.05);
        }

        /* Savings Summary */
        .savings-summary {
            background: linear-gradient(135deg, var(--success), #22c55e);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
        }

        .savings-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .privacy-toggle {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: #2d3748;
            border: 1px solid var(--primary);
            border-right: none;
            border-radius: 25px 0 0 25px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .privacy-toggle:hover {
            background: var(--primary);
        }

        .privacy-toggle svg {
            color: white;
            width: 24px;
            height: 24px;
            vertical-align: middle;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .regime-comparison,
            .input-sections {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .final-amount {
                font-size: 1.5rem;
            }
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .disclaimer {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9rem;
            color: var(--danger);
        }
    </style>
</head>
<body>
    <div id="privacy-toggle-container"></div>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Tax Analysis Report</h1>
            <p>AI-Powered Old vs New Regime Comparison ‚Ä¢ Financial Year 2024-25</p>
        </div>

        

        <!-- Savings Summary -->
        <div id="privacy-toggle-container" style="text-align: right; margin-bottom: -20px;"></div>
        <div class="savings-summary" id="savingsSummary">
            <h2>üí∞ Your Tax Savings</h2>
            <div>By choosing the <span id="recommendedRegime">Old Regime</span>, you save:</div>
            <div class="savings-amount" id="savingsAmount">‚Çπ0</div>
        </div>

        <!-- Main Regime Comparison -->
        <div class="regime-comparison">
            <!-- Old Regime -->
            <div class="regime-card" id="oldRegimeCard">
                <div class="regime-header">
                    <h3 class="regime-title">üèõÔ∏è Old Tax Regime</h3>
                    <span class="recommended-badge" id="oldRegimeBadge">Recommended</span>
                </div>
                <div class="final-amount refund" id="oldRegimeFinal">
                    Refund: ‚Çπ0
                </div>
                <div>
                    <strong>Net Taxable Income:</strong> ‚Çπ<span id="oldTaxableIncome">0</span><br>
                    <strong>Total Tax Liability:</strong> ‚Çπ<span id="oldTaxLiability">0</span><br>
                    <strong>TDS Paid:</strong> ‚Çπ<span id="oldTdsPaid">0</span>
                </div>
            </div>

            <!-- New Regime -->
            <div class="regime-card" id="newRegimeCard">
                <div class="regime-header">
                    <h3 class="regime-title">üÜï New Tax Regime</h3>
                    <span class="not-recommended-badge" id="newRegimeBadge">Not Recommended</span>
                </div>
                <div class="final-amount tax-payable" id="newRegimeFinal">
                    Additional Tax: ‚Çπ0
                </div>
                <div>
                    <strong>Net Taxable Income:</strong> ‚Çπ<span id="newTaxableIncome">0</span><br>
                    <strong>Total Tax Liability:</strong> ‚Çπ<span id="newTaxLiability">0</span><br>
                    <strong>TDS Paid:</strong> ‚Çπ<span id="newTdsPaid">0</span>
                </div>
            </div>
        </div>

        <!-- Input Sections -->
        <div class="input-sections">
            <!-- Income Details -->
            <div class="input-section">
                <h3 class="section-title">üíº Income Details</h3>
                
                <div class="input-group">
                    <label>Basic Salary & Allowances (Section 17-1)</label>
                    <input type="number" id="basicSalary" placeholder="‚Çπ49,58,800">
                </div>
                
                <div class="input-group">
                    <label>Perquisites/ESPP (Section 17-2)</label>
                    <input type="number" id="perquisites" placeholder="‚Çπ3,02,394">
                </div>
                
                <div class="subtotal">
                    Total Salary Income: ‚Çπ<span id="totalSalary">0</span>
                </div>
                
                <div class="input-group">
                    <label>Bank Interest Income</label>
                    <input type="number" id="bankInterest" placeholder="‚Çπ67,701">
                </div>
                
                <div class="input-group">
                    <label>Dividend Income</label>
                    <input type="number" id="dividendIncome" placeholder="‚Çπ13,427">
                </div>
                
                <div class="subtotal">
                    Total Other Income: ‚Çπ<span id="totalOtherIncome">0</span>
                </div>
                
                <div class="subtotal" style="background: rgba(22, 163, 74, 0.1); color: var(--success);">
                    <strong>Gross Total Income: ‚Çπ<span id="grossTotalIncome">0</span></strong>
                </div>

                <div class="input-group">
                    <label>Total TDS Paid</label>
                    <input type="number" id="tdsPaid" placeholder="‚Çπ13,81,059">
                </div>
            </div>

            <!-- Deductions & Exemptions -->
            <div class="input-section">
                <h3 class="section-title">üßæ Deductions & Exemptions (Old Regime)</h3>
                
                <div class="input-group">
                    <label>HRA Exemption</label>
                    <input type="number" id="hraExemption" placeholder="‚Çπ4,08,000">
                </div>
                
                <div class="input-group">
                    <label>Section 80C (ELSS, PPF, etc.) - Max ‚Çπ1,50,000</label>
                    <input type="number" id="section80C" placeholder="‚Çπ1,50,000" max="150000">
                </div>
                
                <div class="input-group">
                    <label>Section 80CCD(1B) - NPS - Max ‚Çπ50,000</label>
                    <input type="number" id="section80CCD1B" placeholder="‚Çπ50,000" max="50000">
                </div>
                
                <div class="input-group">
                    <label>Standard Deduction</label>
                    <input type="number" id="standardDeduction" value="50000" readonly>
                </div>
                
                <div class="input-group">
                    <label>Professional Tax</label>
                    <input type="number" id="professionalTax" placeholder="‚Çπ2,400">
                </div>
                
                <div class="input-group">
                    <label>Section 80D (Health Insurance)</label>
                    <input type="number" id="section80D" placeholder="‚Çπ0">
                </div>
                
                <div class="subtotal" style="background: rgba(220, 38, 38, 0.1); color: var(--danger);">
                    <strong>Total Deductions: ‚Çπ<span id="totalDeductions">0</span></strong>
                </div>
            </div>
        </div>

        <!-- Detailed Calculation -->
        <div class="calculation-details">
            <h3 class="section-title">üßÆ Detailed Tax Calculation</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Old Regime Calculation -->
                <div>
                    <h4>Old Regime Calculation</h4>
                    <table class="calc-table">
                        <tr><td>Gross Total Income</td><td class="amount" id="oldGrossDisplay">‚Çπ0</td></tr>
                        <tr><td>Less: Deductions & Exemptions</td><td class="amount" id="oldDeductionsDisplay">‚Çπ0</td></tr>
                        <tr class="total-row"><td><strong>Net Taxable Income</strong></td><td class="amount"><strong id="oldNetTaxable">‚Çπ0</strong></td></tr>
                        <tr><td>Tax on Income</td><td class="amount" id="oldIncomeTax">‚Çπ0</td></tr>
                        <tr><td>Health & Education Cess (4%)</td><td class="amount" id="oldCess">‚Çπ0</td></tr>
                        <tr class="total-row"><td><strong>Total Tax Liability</strong></td><td class="amount"><strong id="oldTotalTax">‚Çπ0</strong></td></tr>
                        <tr><td>Less: TDS Paid</td><td class="amount" id="oldTdsDisplay">‚Çπ0</td></tr>
                        <tr class="total-row"><td><strong>Final Position</strong></td><td class="amount"><strong id="oldFinalPosition">‚Çπ0</strong></td></tr>
                    </table>
                </div>

                <!-- New Regime Calculation -->
                <div>
                    <h4>New Regime Calculation</h4>
                    <table class="calc-table">
                        <tr><td>Gross Total Income</td><td class="amount" id="newGrossDisplay">‚Çπ0</td></tr>
                        <tr><td>Less: Standard Deduction</td><td class="amount">‚Çπ50,000</td></tr>
                        <tr class="total-row"><td><strong>Net Taxable Income</strong></td><td class="amount"><strong id="newNetTaxable">‚Çπ0</strong></td></tr>
                        <tr><td>Tax on Income</td><td class="amount" id="newIncomeTax">‚Çπ0</td></tr>
                        <tr><td>Surcharge</td><td class="amount" id="newSurcharge">‚Çπ0</td></tr>
                        <tr><td>Health & Education Cess (4%)</td><td class="amount" id="newCess">‚Çπ0</td></tr>
                        <tr class="total-row"><td><strong>Total Tax Liability</strong></td><td class="amount"><strong id="newTotalTax">‚Çπ0</strong></td></tr>
                        <tr><td>Less: TDS Paid</td><td class="amount" id="newTdsDisplay">‚Çπ0</td></tr>
                        <tr class="total-row"><td><strong>Final Position</strong></td><td class="amount"><strong id="newFinalPosition">‚Çπ0</strong></td></tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="window.print()">üñ®Ô∏è Print Report</button>
            <button class="btn" onclick="exportToCSV()" style="margin-left: 10px;">üíæ Export Data</button>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <strong>‚ö†Ô∏è Disclaimer:</strong> This report is generated based on the documents provided and is for informational purposes only. 
            Please consult with a qualified tax professional for accurate and personalized advice before making any tax-related decisions.
        </div>
    </div>

    <script>
        // Privacy Engine Functions
        let privacyMode = true; // Start with privacy enabled

        function maskAmount(amount, showCurrency = true) {
            if (!privacyMode) {
                return (showCurrency ? '‚Çπ' : '') + amount.toLocaleString('en-IN');
            }
            
            const amountStr = amount.toString();
            const length = amountStr.length;
            
            // Generate mask based on amount size
            let mask = '';
            if (length <= 3) {
                mask = 'XXX';
            } else if (length <= 5) {
                mask = 'XX,XXX';
            } else if (length <= 7) {
                mask = 'XX,XX,XXX';
            } else {
                mask = 'X,XX,XX,XXX';
            }
            
            return (showCurrency ? '‚Çπ' : '') + mask;
        }

        function togglePrivacy() {
            privacyMode = !privacyMode;
            
            // Update all privacy toggles
            document.querySelectorAll('.privacy-toggle').forEach(btn => {
                btn.innerHTML = privacyMode ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
                btn.title = privacyMode ? 'Click to show actual amounts' : 'Click to hide amounts';
            });
            
            // Update all financial values
            document.querySelectorAll('[data-amount]').forEach(element => {
                const amount = parseFloat(element.dataset.amount);
                const showCurrency = element.dataset.currency !== 'false';
                element.innerHTML = maskAmount(amount, showCurrency);
            });
            
            // Update privacy status indicator (if exists)
            const indicator = document.getElementById('privacyIndicator');
            if (indicator) {
                indicator.innerHTML = privacyMode ? 
                    'üîí Privacy Mode: ON' : 
                    'üîì Privacy Mode: OFF';
                indicator.style.color = privacyMode ? '#16a34a' : '#d97706';
            }
        }

        function createPrivacyToggleButton() {
            const container = document.getElementById('privacy-toggle-container');
            if (container) {
                container.innerHTML = `<button class="privacy-toggle" onclick="togglePrivacy()" title="Toggle privacy mode"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg></button>`;
            }
        }

        // Utility functions
        const fmt = (amount) => Math.round(amount || 0).toLocaleString('en-IN');
        const parseAmount = (value) => parseFloat(value) || 0;

        // Data model
        let taxData = {
            income: {
                basicSalary: 0,
                perquisites: 0,
                bankInterest: 0,
                dividendIncome: 0,
                tdsPaid: 0
            },
            deductions: {
                hraExemption: 0,
                section80C: 0,
                section80CCD1B: 0,
                standardDeduction: 50000,
                professionalTax: 0,
                section80D: 0
            }
        };

        // Load real analysis data
        async function loadAnalysisData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session_id');
                
                if (!sessionId) {
                    console.log('No session_id provided, using default values');
                    return;
                }

                const response = await fetch(`/api/sessions/${sessionId}/analysis_results/`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const apiData = await response.json();
                const analysisData = apiData.tax_summary || {};
                
                // Map API data to form fields
                const incomeBreakdown = analysisData.income_breakdown || {};
                const salaryIncome = incomeBreakdown.salary_income || {};
                const otherIncome = incomeBreakdown.other_income || {};
                const deductionsData = analysisData.deductions_old_regime || {};
                const oldRegimeCalc = analysisData.tax_calculation_old_regime || {};
                
                // Update data model
                taxData.income = {
                    basicSalary: salaryIncome.basic_and_allowances_17_1 || 0,
                    perquisites: salaryIncome.perquisites_espp_17_2 || 0,
                    bankInterest: otherIncome.bank_interest || 0,
                    dividendIncome: otherIncome.dividend_income || 0,
                    tdsPaid: oldRegimeCalc.tds_paid || 0
                };
                
                taxData.deductions = {
                    hraExemption: deductionsData.hra_exemption || 0,
                    section80C: deductionsData.section_80c || 0,
                    section80CCD1B: deductionsData.section_80ccd_1b || 0,
                    standardDeduction: 50000,
                    professionalTax: deductionsData.professional_tax || 0,
                    section80D: 0 // Not in current API data
                };
                
                console.log('Loaded tax data:', taxData);
                
                // Update form fields
                updateFormFields();
                
            } catch (error) {
                console.error('Error loading analysis data:', error);
            }
        }

        // Update form fields with loaded data
        function updateFormFields() {
            document.getElementById('basicSalary').value = taxData.income.basicSalary;
            document.getElementById('perquisites').value = taxData.income.perquisites;
            document.getElementById('bankInterest').value = taxData.income.bankInterest;
            document.getElementById('dividendIncome').value = taxData.income.dividendIncome;
            document.getElementById('tdsPaid').value = taxData.income.tdsPaid;
            
            document.getElementById('hraExemption').value = taxData.deductions.hraExemption;
            document.getElementById('section80C').value = taxData.deductions.section80C;
            document.getElementById('section80CCD1B').value = taxData.deductions.section80CCD1B;
            document.getElementById('professionalTax').value = taxData.deductions.professionalTax;
            document.getElementById('section80D').value = taxData.deductions.section80D;
            
            calculateTax();
        }

        // Tax calculation functions
        function calculateOldRegimeTax(taxableIncome) {
            let tax = 0;
            
            if (taxableIncome <= 250000) tax = 0;
            else if (taxableIncome <= 500000) tax = (taxableIncome - 250000) * 0.05;
            else if (taxableIncome <= 1000000) tax = 12500 + (taxableIncome - 500000) * 0.20;
            else tax = 112500 + (taxableIncome - 1000000) * 0.30;
            
            return tax;
        }

        function calculateNewRegimeTax(taxableIncome) {
            let tax = 0;
            
            if (taxableIncome <= 300000) tax = 0;
            else if (taxableIncome <= 600000) tax = (taxableIncome - 300000) * 0.05;
            else if (taxableIncome <= 900000) tax = 15000 + (taxableIncome - 600000) * 0.10;
            else if (taxableIncome <= 1200000) tax = 45000 + (taxableIncome - 900000) * 0.15;
            else if (taxableIncome <= 1500000) tax = 90000 + (taxableIncome - 1200000) * 0.20;
            else if (taxableIncome <= 5000000) tax = 150000 + (taxableIncome - 1500000) * 0.30;
            else tax = 1200000 + (taxableIncome - 5000000) * 0.30;
            
            return tax;
        }

        // Main calculation function
        function calculateTax() {
            // Get current values from form
            const income = {
                basicSalary: parseAmount(document.getElementById('basicSalary').value),
                perquisites: parseAmount(document.getElementById('perquisites').value),
                bankInterest: parseAmount(document.getElementById('bankInterest').value),
                dividendIncome: parseAmount(document.getElementById('dividendIncome').value),
                tdsPaid: parseAmount(document.getElementById('tdsPaid').value)
            };
            
            const deductions = {
                hraExemption: parseAmount(document.getElementById('hraExemption').value),
                section80C: Math.min(parseAmount(document.getElementById('section80C').value), 150000),
                section80CCD1B: Math.min(parseAmount(document.getElementById('section80CCD1B').value), 50000),
                standardDeduction: 50000,
                professionalTax: parseAmount(document.getElementById('professionalTax').value),
                section80D: parseAmount(document.getElementById('section80D').value)
            };
            
            // Calculate totals
            const totalSalary = income.basicSalary + income.perquisites;
            const totalOtherIncome = income.bankInterest + income.dividendIncome;
            const grossTotalIncome = totalSalary + totalOtherIncome;
            const totalDeductionsOld = deductions.hraExemption + deductions.section80C + 
                                    deductions.section80CCD1B + deductions.standardDeduction + 
                                    deductions.professionalTax + deductions.section80D;
            
            // Old Regime Calculation
            const oldTaxableIncome = Math.max(0, grossTotalIncome - totalDeductionsOld);
            const oldIncomeTax = calculateOldRegimeTax(oldTaxableIncome);
            const oldCess = oldIncomeTax * 0.04;
            const oldTotalTax = oldIncomeTax + oldCess;
            const oldFinalPosition = income.tdsPaid - oldTotalTax;
            
            // New Regime Calculation
            const newTaxableIncome = Math.max(0, grossTotalIncome - deductions.standardDeduction);
            const newIncomeTax = calculateNewRegimeTax(newTaxableIncome);
            const newSurcharge = newTaxableIncome > 5000000 ? newIncomeTax * 0.10 : 0;
            const newCess = (newIncomeTax + newSurcharge) * 0.04;
            const newTotalTax = newIncomeTax + newSurcharge + newCess;
            const newFinalPosition = income.tdsPaid - newTotalTax;
            
            // Update UI
            updateUI({
                totalSalary,
                totalOtherIncome,
                grossTotalIncome,
                totalDeductionsOld,
                oldTaxableIncome,
                oldIncomeTax,
                oldCess,
                oldTotalTax,
                oldFinalPosition,
                newTaxableIncome,
                newIncomeTax,
                newSurcharge,
                newCess,
                newTotalTax,
                newFinalPosition,
                tdsPaid: income.tdsPaid
            });
        }

        // Update UI with calculated values
        function updateUI(calc) {
            // Helper function to update element with privacy support
            function updateElement(id, amount) {
                const element = document.getElementById(id);
                if (element) {
                    element.setAttribute('data-amount', amount);
                    element.innerHTML = maskAmount(amount, true);
                }
            }
            
            // Income totals
            updateElement('totalSalary', calc.totalSalary);
            updateElement('totalOtherIncome', calc.totalOtherIncome);
            updateElement('grossTotalIncome', calc.grossTotalIncome);
            updateElement('totalDeductions', calc.totalDeductionsOld);
            
            // Regime comparison cards
            updateElement('oldTaxableIncome', calc.oldTaxableIncome);
            updateElement('oldTaxLiability', calc.oldTotalTax);
            updateElement('oldTdsPaid', calc.tdsPaid);
            
            updateElement('newTaxableIncome', calc.newTaxableIncome);
            updateElement('newTaxLiability', calc.newTotalTax);
            updateElement('newTdsPaid', calc.tdsPaid);
            
            // Final positions
            const oldCard = document.getElementById('oldRegimeCard');
            const newCard = document.getElementById('newRegimeCard');
            const oldFinal = document.getElementById('oldRegimeFinal');
            const newFinal = document.getElementById('newRegimeFinal');
            const oldBadge = document.getElementById('oldRegimeBadge');
            const newBadge = document.getElementById('newRegimeBadge');
            
            if (calc.oldFinalPosition >= 0) {
                oldFinal.setAttribute('data-amount', calc.oldFinalPosition);
                oldFinal.innerHTML = `Refund: ${maskAmount(calc.oldFinalPosition, true)}`;
                oldFinal.className = 'final-amount refund';
            } else {
                oldFinal.setAttribute('data-amount', -calc.oldFinalPosition);
                oldFinal.innerHTML = `Tax Payable: ${maskAmount(-calc.oldFinalPosition, true)}`;
                oldFinal.className = 'final-amount tax-payable';
            }
            
            if (calc.newFinalPosition >= 0) {
                newFinal.setAttribute('data-amount', calc.newFinalPosition);
                newFinal.innerHTML = `Refund: ${maskAmount(calc.newFinalPosition, true)}`;
                newFinal.className = 'final-amount refund';
            } else {
                newFinal.setAttribute('data-amount', -calc.newFinalPosition);
                newFinal.innerHTML = `Tax Payable: ${maskAmount(-calc.newFinalPosition, true)}`;
                newFinal.className = 'final-amount tax-payable';
            }
            
            // Determine recommendation
            const savings = calc.oldFinalPosition - calc.newFinalPosition;
            if (savings > 0) {
                // Old regime is better
                oldCard.className = 'regime-card recommended';
                newCard.className = 'regime-card not-recommended';
                oldBadge.className = 'recommended-badge';
                oldBadge.textContent = 'Recommended';
                newBadge.className = 'not-recommended-badge';
                newBadge.textContent = 'Not Recommended';
                document.getElementById('recommendedRegime').textContent = 'Old Regime';
                updateElement('savingsAmount', savings);
            } else {
                // New regime is better
                oldCard.className = 'regime-card not-recommended';
                newCard.className = 'regime-card recommended';
                oldBadge.className = 'not-recommended-badge';
                oldBadge.textContent = 'Not Recommended';
                newBadge.className = 'recommended-badge';
                newBadge.textContent = 'Recommended';
                document.getElementById('recommendedRegime').textContent = 'New Regime';
                updateElement('savingsAmount', -savings);
            }
            
            // Detailed calculation tables with privacy support
            updateElement('oldGrossDisplay', calc.grossTotalIncome);
            updateElement('oldDeductionsDisplay', calc.totalDeductionsOld);
            updateElement('oldNetTaxable', calc.oldTaxableIncome);
            updateElement('oldIncomeTax', calc.oldIncomeTax);
            updateElement('oldCess', calc.oldCess);
            updateElement('oldTotalTax', calc.oldTotalTax);
            updateElement('oldTdsDisplay', calc.tdsPaid);
            
            // Old regime final position with privacy
            const oldFinalPosElement = document.getElementById('oldFinalPosition');
            if (oldFinalPosElement) {
                if (calc.oldFinalPosition >= 0) {
                    oldFinalPosElement.setAttribute('data-amount', calc.oldFinalPosition);
                    oldFinalPosElement.innerHTML = `Refund: ${maskAmount(calc.oldFinalPosition, true)}`;
                } else {
                    oldFinalPosElement.setAttribute('data-amount', -calc.oldFinalPosition);
                    oldFinalPosElement.innerHTML = `Tax Due: ${maskAmount(-calc.oldFinalPosition, true)}`;
                }
            }
            
            updateElement('newGrossDisplay', calc.grossTotalIncome);
            updateElement('newNetTaxable', calc.newTaxableIncome);
            updateElement('newIncomeTax', calc.newIncomeTax);
            updateElement('newSurcharge', calc.newSurcharge);
            updateElement('newCess', calc.newCess);
            updateElement('newTotalTax', calc.newTotalTax);
            updateElement('newTdsDisplay', calc.tdsPaid);
            
            // New regime final position with privacy
            const newFinalPosElement = document.getElementById('newFinalPosition');
            if (newFinalPosElement) {
                if (calc.newFinalPosition >= 0) {
                    newFinalPosElement.setAttribute('data-amount', calc.newFinalPosition);
                    newFinalPosElement.innerHTML = `Refund: ${maskAmount(calc.newFinalPosition, true)}`;
                } else {
                    newFinalPosElement.setAttribute('data-amount', -calc.newFinalPosition);
                    newFinalPosElement.innerHTML = `Tax Due: ${maskAmount(-calc.newFinalPosition, true)}`;
                }
            }
        }

        // Export functionality
        function exportToCSV() {
            const data = [
                ['Field', 'Amount'],
                ['Basic Salary & Allowances', document.getElementById('basicSalary').value],
                ['Perquisites/ESPP', document.getElementById('perquisites').value],
                ['Bank Interest', document.getElementById('bankInterest').value],
                ['Dividend Income', document.getElementById('dividendIncome').value],
                ['TDS Paid', document.getElementById('tdsPaid').value],
                ['HRA Exemption', document.getElementById('hraExemption').value],
                ['Section 80C', document.getElementById('section80C').value],
                ['Section 80CCD(1B)', document.getElementById('section80CCD1B').value],
                ['Professional Tax', document.getElementById('professionalTax').value],
                ['Section 80D', document.getElementById('section80D').value]
            ];
            
            const csv = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tax_analysis_data.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to all input fields
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', calculateTax);
            });
            
            // Load initial data
            loadAnalysisData();
            
            // Initialize privacy mode after a short delay to ensure all elements are rendered
            setTimeout(() => {
                // Apply initial privacy masking without toggling (keep privacy ON by default)
                document.querySelectorAll('[data-amount]').forEach(element => {
                    const amount = parseFloat(element.dataset.amount);
                    const showCurrency = element.dataset.currency !== 'false';
                    element.innerHTML = maskAmount(amount, showCurrency);
                });
            }, 100);

            createPrivacyToggleButton();
        });
    </script>
</body>
</html>